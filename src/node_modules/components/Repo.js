import React, { useContext, useEffect, useState } from 'react'
import classnames from 'classnames'
import { Link } from 'react-router-dom'

import { routesMap } from 'routes'

import { ThemeContext, LIGHT, DARK } from 'contexts'
import useFetch from 'hooks/useFetch'
import { Modal } from 'components/Modal'

export default function Repo({ repo }) {
  const [theme,] = useContext(ThemeContext)
  const apiUrl = `/repos/weynemeynen/${repo.name}/contents`
  const [{ response, isLoading, error }, doFetch] = useFetch(apiUrl)

  const [displayModal, setDisplayModal] = useState(false)
  const [dirName, setDirName] = useState('')

  useEffect(() => {
    doFetch()
  }, [doFetch])

  function showModal(nameDir) {
    setDirName(nameDir)
    setDisplayModal(true)
  }

  function handleClose(e) {
    if (e.key == 'Escape' || e.type === 'click') setDisplayModal(false)
  }

  useEffect(() => {
    addEventListener('keydown', handleClose);
    return () => removeEventListener('keydown', handleClose)
  }, [])

  const buttonClasses = classnames({
    'btn-outline-primary': theme === LIGHT,
    'btn-outline-info': theme === DARK,
  })
  const backClasses = classnames({
    'text-info': theme === DARK
  })

  const dirs = response.map((dir) => {
    if (
      dir.type === 'dir'
      // скрыть директори
      && dir.name !== 'github-profiles'
      && dir.name !== 'dom-array-methods'
      && dir.name !== 'sofia'
    ) {
      return (
        <button className={`btn btn-lg rounded-pill me-2 mb-2 ${buttonClasses}`}
          role='button'
          key={dir.name}
          onClick={() => showModal(dir.name)}
        >
          {dir.name}
        </button>
      )
    }
  })

  return (
    <>
      <h1 className='my-4 ps-3 d-flex align-items-baseline'>
        <Link to={routesMap.repositories} className={`bi-arrow-left-circle fs-4 me-2 ${backClasses}`} title='назад'></Link>
        <span>{repo.name}</span>
      </h1>
      <div className='directories ps-3'>{dirs}</div>
      <Modal
        display={displayModal}
        handleClose={handleClose}
        repoName={repo.name}
        dirName={dirName}
      />
    </>
  )
}